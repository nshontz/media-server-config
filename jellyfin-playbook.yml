---
- name: Install and Configure Jellyfin Media Server
  hosts: jellyfin_servers
  become: yes
  vars:
    jellyfin_domain: "{{ vault_jellyfin_domain | default('jelly.saltgrip.com') }}"
    jellyfin_email: "{{ vault_jellyfin_email | default('nickshontz@gmail.com') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Add universe repository
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
        state: present

    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - wget
          - curl
          - gnupg
          - lsb-release
          - openssh-server
          - vim
          - ufw
          - samba
          - snapd
          - avahi-daemon
          - exfat-fuse
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
          - nodejs
          - npm
          - git
        state: present

    - name: Configure network interface enp1s0 with static IP
      copy:
        content: |
          # WARNING: This file is managed by Ansible.
          # DO NOT EDIT MANUALLY - Changes will be overwritten.
          # Edit the source file in the Ansible repository instead.
          
          network:
            version: 2
            ethernets:
              enp1s0:
                dhcp4: false
                dhcp6: false
                addresses:
                  - 192.168.68.94/24
                gateway4: 192.168.68.1
                nameservers:
                  addresses: [8.8.8.8, 8.8.4.4]
                optional: false
        dest: /etc/netplan/01-ethernet.yaml
        owner: root
        group: root
        mode: '0644'
      notify: apply netplan

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Jellyfin GPG key
      get_url:
        url: https://repo.jellyfin.org/jellyfin_team.gpg.key
        dest: /etc/apt/keyrings/jellyfin_team.gpg.key
        mode: '0644'

    - name: Add Jellyfin repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/jellyfin_team.gpg.key] https://repo.jellyfin.org/ubuntu {{ ansible_distribution_release }} main"
        filename: jellyfin
        state: present

    - name: Add Caddy GPG key
      shell: curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Add Caddy repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        filename: caddy-stable
        state: present

    - name: Update apt cache after adding repositories
      apt:
        update_cache: yes

    - name: Install Jellyfin and web client
      apt:
        name:
          - jellyfin
          - jellyfin-web
        state: present

    - name: Install Caddy
      apt:
        name: caddy
        state: present

    - name: Enable Jellyfin service
      systemd:
        name: jellyfin
        enabled: yes
        daemon_reload: yes

    - name: Start Jellyfin service
      systemd:
        name: jellyfin
        state: started

    - name: Wait for Jellyfin to start
      wait_for:
        port: 8096
        host: localhost
        timeout: 120

    - name: Check if Jellyfin configuration directory exists
      stat:
        path: /etc/jellyfin
      register: jellyfin_config_dir

    - name: Create Jellyfin configuration directory
      file:
        path: /etc/jellyfin
        state: directory
        owner: jellyfin
        group: jellyfin
        mode: '0755'
      when: not jellyfin_config_dir.stat.exists

#    - name: Copy Jellyfin configuration files # these files are edited by Jellyfin, we shouldn't meddle
#      copy:
#        src: files/etc/jellyfin/
#        dest: /etc/jellyfin/
#        owner: jellyfin
#        group: jellyfin
#        mode: '0644'
#      notify: restart jellyfin
#      when: not jellyfin_config_dir.stat.exists

    - name: Configure firewall rules
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: "22", proto: "tcp" }
        - { port: "80", proto: "tcp" }
        - { port: "443", proto: "tcp" }
        - { port: "443", proto: "udp" }
        - { port: "8096", proto: "tcp" }
        - { port: "8920", proto: "tcp" }
        - { port: "1900", proto: "udp" }
        - { port: "7359", proto: "udp" }

    - name: Allow Samba through firewall
      ufw:
        rule: allow
        name: Samba

    - name: Enable firewall
      ufw:
        state: enabled

    - name: Create mount point for external drive
      file:
        path: /mnt/phat
        state: directory
        mode: '0755'

    - name: Add fstab entry for external drive
      lineinfile:
        path: /etc/fstab
        line: "UUID=BAEC-B479 /mnt/phat exfat umask=000,uid=1000,gid=1000,nofail 0 0"
        state: present
        backup: yes

    - name: Create shared media directory
      file:
        path: /srv/media
        state: directory
        mode: '0777'
        owner: nobody
        group: nogroup

    - name: Create movies directory on external drive
      file:
        path: /mnt/phat/movies
        state: directory
        mode: '0777'
        owner: nobody
        group: nogroup

    - name: Configure Samba global settings for Mac compatibility
      blockinfile:
        path: /etc/samba/smb.conf
        insertafter: "\\[global\\]"
        block: |
          # Mac compatibility settings
          vfs objects = catia fruit streams_xattr
          fruit:metadata = stream
          fruit:model = MacSamba
          fruit:posix_rename = yes
          fruit:veto_appledouble = no
          fruit:wipe_intentionally_left_blank_rfork = yes
          fruit:delete_empty_adfiles = yes
          fruit:advertise_fullsync = true
          
          # Network discovery
          netbios name = JELLYFIN-SERVER
          server string = Jellyfin Media Server
          workgroup = WORKGROUP
          
          # Enable network browsing
          local master = yes
          domain master = yes
          preferred master = yes
          os level = 65
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Mac Compatibility"
      notify: restart samba

    - name: Configure Samba share for media folder
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [internal]
              comment = Jellyfin Media Share
              path = /srv/media
              browseable = yes
              read only = no
              guest ok = yes
              public = yes
              writable = yes
              create mask = 0666
              directory mask = 0777
              force user = nobody
              force group = nogroup
              wide links = yes
              unix extensions = no
              # Mac-specific options
              vfs objects = catia fruit streams_xattr
              fruit:time machine = no
              fruit:locking = netatalk
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Media Share"
      notify: restart samba

    - name: Configure Samba share for movies folder
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [big-red]
              comment = Movies Share
              path = /mnt/media-library/
              browseable = yes
              read only = no
              guest ok = yes
              public = yes
              writable = yes
              create mask = 0666
              directory mask = 0777
              force user = nobody
              force group = nogroup
              wide links = yes
              unix extensions = no
              # Mac-specific options
              vfs objects = catia fruit streams_xattr
              fruit:time machine = no
              fruit:locking = netatalk
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Movies Share"
      notify: restart samba

    - name: Start and enable Samba service
      systemd:
        name: smbd
        state: started
        enabled: yes

    - name: Start and enable Avahi daemon for network discovery
      systemd:
        name: avahi-daemon
        state: started
        enabled: yes

    - name: Create Caddyfile for Jellyfin reverse proxy
      copy:
        content: |
          # WARNING: This file is managed by Ansible.
          # DO NOT EDIT MANUALLY - Changes will be overwritten.
          # Edit the source file in the Ansible repository instead.
          
          {{ jellyfin_domain }} {
              reverse_proxy 127.0.0.1:8096
          }
        dest: /etc/caddy/Caddyfile
        owner: root
        group: root
        mode: '0644'
      notify: restart caddy

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Create Jellyfin backup directory
      file:
        path: /mnt/media-server/jellyfin-backup
        state: directory
        mode: '0755'

    - name: Create daily Jellyfin configuration backup cron job
      cron:
        name: "Backup Jellyfin configuration"
        minute: "0"
        hour: "2"
        job: "rsync -av --delete /etc/jellyfin/ /mnt/media-server/jellyfin-backup/"
        user: root

    - name: Create media-library directory structure
      file:
        path: /mnt/media-library/Unknown
        state: directory
        mode: '0755'
        recurse: yes

    - name: Create live TV directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: jellyfin
        group: jellyfin
      loop:
        - /var/lib/jellyfin/livetv
        - /var/lib/jellyfin/livetv/epg
        - /opt/iptv-epg

    - name: Add /opt/iptv-epg as git safe directory
      command: git config --global --add safe.directory /opt/iptv-epg

    - name: Clone iptv-org/epg repository
      git:
        repo: https://github.com/iptv-org/epg.git
        dest: /opt/iptv-epg
        update: yes
        force: yes

    - name: Install EPG dependencies
      npm:
        path: /opt/iptv-epg

    - name: Download M3U playlist
      get_url:
        url: https://iptv-org.github.io/iptv/index.m3u
        dest: /var/lib/jellyfin/livetv/channels_raw.m3u
        mode: '0644'
        owner: jellyfin
        group: jellyfin

#    - name: Filter out problematic channels from M3U playlist
#      shell: |
#        grep -v -E "(flix|BET|MTV|VH1|Comedy Central|Nickelodeon|Nick Jr|TeenNick|TV Land|Paramount|Pluto)" /var/lib/jellyfin/livetv/channels_raw.m3u > /var/lib/jellyfin/livetv/channels.m3u || true
#        chown jellyfin:jellyfin /var/lib/jellyfin/livetv/channels.m3u

    - name: Try downloading USA Local EPG data first
      get_url:
        url: https://raw.githubusercontent.com/usa-local-epg/usa-locals/main/usalocals.xml.gz
        dest: /tmp/usalocals.xml.gz
        mode: '0644'
      ignore_errors: yes
      register: usa_epg_download

    - name: Extract USA Local EPG data if download succeeded
      shell: gunzip -c /tmp/usalocals.xml.gz > /var/lib/jellyfin/livetv/epg/guide.xml
      when: usa_epg_download is succeeded
      ignore_errors: yes
      register: usa_epg_extract

    - name: Generate EPG using iptv-org/epg as fallback
      shell: cd /opt/iptv-epg && npm run grab -- --site=ontvtonight.com
      when: usa_epg_download is failed or usa_epg_extract is failed
      ignore_errors: yes

    - name: Copy generated EPG to Jellyfin directory (fallback)
      copy:
        src: /opt/iptv-epg/guide.xml
        dest: /var/lib/jellyfin/livetv/epg/guide.xml
        remote_src: yes
        owner: jellyfin
        group: jellyfin
        mode: '0644'
      when: usa_epg_download is failed or usa_epg_extract is failed
      ignore_errors: yes

    - name: Set EPG file ownership
      file:
        path: /var/lib/jellyfin/livetv/epg/guide.xml
        owner: jellyfin
        group: jellyfin
        mode: '0644'

    - name: Create daily media file move cron job
      cron:
        name: "Move media files to library"
        minute: "0"
        hour: "12"
        job: "find /srv/media/ -mindepth 1 -maxdepth 1 -exec mv {} /mnt/media-library/Unknown/ \\;"
        user: root

    - name: Create daily EPG update cron job
      cron:
        name: "Update EPG data"
        minute: "30"
        hour: "6"
        job: "(wget -O /tmp/usalocals.xml.gz https://raw.githubusercontent.com/usa-local-epg/usa-locals/main/usalocals.xml.gz && gunzip -c /tmp/usalocals.xml.gz > /var/lib/jellyfin/livetv/epg/guide.xml) || (cd /opt/iptv-epg && npm run grab -- --site=ontvtonight.com && cp guide.xml /var/lib/jellyfin/livetv/epg/guide.xml); chown jellyfin:jellyfin /var/lib/jellyfin/livetv/epg/guide.xml"
        user: root

    - name: Create daily M3U playlist update cron job
      cron:
        name: "Update M3U playlist"
        minute: "15"
        hour: "6"
        job: "wget -O /var/lib/jellyfin/livetv/channels_raw.m3u https://iptv-org.github.io/iptv/index.m3u && grep -v -E '(flix|BET|MTV|VH1|Comedy Central|Nickelodeon|Nick Jr|TeenNick|TV Land|Paramount|Pluto)' /var/lib/jellyfin/livetv/channels_raw.m3u > /var/lib/jellyfin/livetv/channels.m3u && chown jellyfin:jellyfin /var/lib/jellyfin/livetv/channels.m3u"
        user: root


  handlers:
    - name: apply netplan
      command: netplan apply

    - name: restart jellyfin
      systemd:
        name: jellyfin
        state: restarted

    - name: restart samba
      systemd:
        name: smbd
        state: restarted

    - name: restart caddy
      systemd:
        name: caddy
        state: restarted