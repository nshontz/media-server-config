---
- name: Install and Configure Jellyfin Media Server
  hosts: jellyfin_servers
  become: yes
  vars:
    jellyfin_plugins:
      - name: "Session Cleaner"
        repo_url: "https://github.com/jellyfin/jellyfin-plugin-sessioncleaner/releases/latest/download/Jellyfin.Plugin.SessionCleaner.dll"
      - name: "SkinManager"
        repo_url: "https://github.com/danieladov/jellyfin-plugin-skin-manager/releases/latest/download/SkinManager.dll"
      - name: "Playback Reporting"
        repo_url: "https://github.com/jellyfin/jellyfin-plugin-playbackreporting/releases/latest/download/Jellyfin.Plugin.PlaybackReporting.dll"
      - name: "Subtitle Extract"
        repo_url: "https://github.com/jellyfin/jellyfin-plugin-subtitleextract/releases/latest/download/Jellyfin.Plugin.SubtitleExtract.dll"
      - name: "Intro Skipper"
        repo_url: "https://github.com/ConfusedPolarBear/intro-skipper/releases/latest/download/Jellyfin.Plugin.IntroSkipper.dll"
    
    # Jellystat configuration
#    jellystat_postgres_password: "{{ vault_postgres_password | default('changeme123') }}"
#    jellystat_jwt_secret: "{{ vault_jwt_secret | default('changeme-jwt-secret-64-chars-long-for-security-purposes') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - wget
          - curl
          - gnupg
          - lsb-release
          - openssh-server
          - vim
          - ufw
          - samba
          - snapd
          - avahi-daemon
        state: present

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Jellyfin GPG key
      get_url:
        url: https://repo.jellyfin.org/jellyfin_team.gpg.key
        dest: /etc/apt/keyrings/jellyfin_team.gpg.key
        mode: '0644'

    - name: Add Jellyfin repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/jellyfin_team.gpg.key] https://repo.jellyfin.org/ubuntu {{ ansible_distribution_release }} main"
        filename: jellyfin
        state: present

    - name: Update apt cache after adding repository
      apt:
        update_cache: yes

    - name: Install Jellyfin
      apt:
        name: jellyfin
        state: present

    - name: Enable Jellyfin service
      systemd:
        name: jellyfin
        enabled: yes
        daemon_reload: yes

    - name: Start Jellyfin service
      systemd:
        name: jellyfin
        state: started

    - name: Wait for Jellyfin to start
      wait_for:
        port: 8096
        host: localhost
        timeout: 120

    - name: Create Jellyfin configuration directory
      file:
        path: /etc/jellyfin
        state: directory
        owner: jellyfin
        group: jellyfin
        mode: '0755'

    - name: Configure encoding settings for Apple TV compatibility
      copy:
        content: |
          {
            "EncodingOptions": {
              "HardwareAccelerationType": "vaapi",
              "EnableHardwareEncoding": true,
              "EnableHardwareDecoding": true,
              "EnableDecodingColorDepth10Hevc": true,
              "EnableDecodingColorDepth10Vp9": true,
              "PreferSystemNativeHwDecoder": true,
              "EnableIntelLowPowerH264HwEncoder": true,
              "EnableIntelLowPowerHevcHwEncoder": true,
              "H264Crf": 23,
              "H265Crf": 28,
              "DeinterlaceDoubleRate": false,
              "DeinterlaceMethod": "yadif",
              "EnableTonemapping": true,
              "TonemappingAlgorithm": "hable",
              "TonemappingMode": "auto",
              "TonemappingRange": "auto",
              "VppTonemappingAlgorithm": "bt2390",
              "H264PreferredFormat": "baseline",
              "TranscodingThreadCount": 0
            }
          }
        dest: /etc/jellyfin/encoding.xml
        owner: jellyfin
        group: jellyfin
        mode: '0644'
      notify: restart jellyfin

    - name: Configure firewall for Jellyfin
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: "22", proto: "tcp" }
        - { port: "8096", proto: "tcp" }
        - { port: "8920", proto: "tcp" }
        - { port: "1900", proto: "udp" }
        - { port: "7359", proto: "udp" }

    - name: Allow Samba through firewall
      ufw:
        rule: allow
        name: Samba

    - name: Enable firewall
      ufw:
        state: enabled

    - name: Create shared media directory
      file:
        path: /srv/media
        state: directory
        mode: '0755'
        owner: nobody
        group: nogroup

    - name: Configure Samba global settings for Mac compatibility
      blockinfile:
        path: /etc/samba/smb.conf
        insertafter: "\\[global\\]"
        block: |
          # Mac compatibility settings
          vfs objects = catia fruit streams_xattr
          fruit:metadata = stream
          fruit:model = MacSamba
          fruit:posix_rename = yes
          fruit:veto_appledouble = no
          fruit:wipe_intentionally_left_blank_rfork = yes
          fruit:delete_empty_adfiles = yes
          fruit:advertise_fullsync = true
          
          # Network discovery
          netbios name = JELLYFIN-SERVER
          server string = Jellyfin Media Server
          workgroup = WORKGROUP
          
          # Enable network browsing
          local master = yes
          domain master = yes
          preferred master = yes
          os level = 65
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Mac Compatibility"
      notify: restart samba

    - name: Configure Samba share for media folder
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [media]
              comment = Jellyfin Media Share
              path = /srv/media
              browseable = yes
              read only = no
              guest ok = yes
              create mask = 0664
              directory mask = 0775
              force user = nobody
              force group = nogroup
              # Mac-specific options
              vfs objects = catia fruit streams_xattr
              fruit:time machine = no
              fruit:locking = netatalk
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Media Share"
      notify: restart samba

    - name: Start and enable Samba service
      systemd:
        name: smbd
        state: started
        enabled: yes

    - name: Start and enable Avahi daemon for network discovery
      systemd:
        name: avahi-daemon
        state: started
        enabled: yes

    - name: Install Certbot for Let's Encrypt SSL
      snap:
        name: certbot
        classic: yes

    - name: Create certbot symlink
      file:
        src: /snap/bin/certbot
        dest: /usr/bin/certbot
        state: link

  handlers:
    - name: restart jellyfin
      systemd:
        name: jellyfin
        state: restarted

    - name: restart samba
      systemd:
        name: smbd
        state: restarted