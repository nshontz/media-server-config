---
- name: Install and Configure Jellyfin Media Server
  hosts: jellyfin_servers
  become: yes
  vars:
    jellyfin_domain: "{{ vault_jellyfin_domain | default('jelly.saltgrip.com') }}"
    jellyfin_email: "{{ vault_jellyfin_email | default('nickshontz@gmail.com') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Add universe repository
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
        state: present

    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - wget
          - curl
          - gnupg
          - lsb-release
          - openssh-server
          - vim
          - ufw
          - samba
          - snapd
          - avahi-daemon
          - exfat-fuse
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
        state: present

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Jellyfin GPG key
      get_url:
        url: https://repo.jellyfin.org/jellyfin_team.gpg.key
        dest: /etc/apt/keyrings/jellyfin_team.gpg.key
        mode: '0644'

    - name: Add Jellyfin repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/jellyfin_team.gpg.key] https://repo.jellyfin.org/ubuntu {{ ansible_distribution_release }} main"
        filename: jellyfin
        state: present

    - name: Add Caddy GPG key
      shell: curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Add Caddy repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        filename: caddy-stable
        state: present

    - name: Update apt cache after adding repositories
      apt:
        update_cache: yes

    - name: Install Jellyfin
      apt:
        name: jellyfin
        state: present

    - name: Install Caddy
      apt:
        name: caddy
        state: present

    - name: Enable Jellyfin service
      systemd:
        name: jellyfin
        enabled: yes
        daemon_reload: yes

    - name: Start Jellyfin service
      systemd:
        name: jellyfin
        state: started

    - name: Wait for Jellyfin to start
      wait_for:
        port: 8096
        host: localhost
        timeout: 120

    - name: Create Jellyfin configuration directory
      file:
        path: /etc/jellyfin
        state: directory
        owner: jellyfin
        group: jellyfin
        mode: '0755'

    - name: Configure Jellyfin for reverse proxy
      copy:
        content: |
          {
            "EncodingOptions": {
              "HardwareAccelerationType": "vaapi",
              "EnableHardwareEncoding": true,
              "EnableHardwareDecoding": true,
              "EnableDecodingColorDepth10Hevc": true,
              "EnableDecodingColorDepth10Vp9": true,
              "PreferSystemNativeHwDecoder": true,
              "EnableIntelLowPowerH264HwEncoder": true,
              "EnableIntelLowPowerHevcHwEncoder": true,
              "H264Crf": 23,
              "H265Crf": 28,
              "DeinterlaceDoubleRate": false,
              "DeinterlaceMethod": "yadif",
              "EnableTonemapping": true,
              "TonemappingAlgorithm": "hable",
              "TonemappingMode": "auto",
              "TonemappingRange": "auto",
              "VppTonemappingAlgorithm": "bt2390",
              "H264PreferredFormat": "baseline",
              "TranscodingThreadCount": 0
            },
            "NetworkConfiguration": {
              "RequireHttps": false,
              "BaseUrl": "",
              "PublicHttpsPort": 443,
              "HttpServerPortNumber": 8096,
              "HttpsPortNumber": 8920,
              "EnableHttps": false,
              "KnownProxies": ["127.0.0.1"],
              "TrustAllIP6Interfaces": false,
              "HDHomerunPortRange": "",
              "PublishedServerUriBySubnet": [],
              "AutoDiscoveryTracing": false,
              "AutoDiscovery": true,
              "RemoteIPFilter": [],
              "IsRemoteIPFilterBlacklist": false
            }
          }
        dest: /etc/jellyfin/system.xml
        owner: jellyfin
        group: jellyfin
        mode: '0644'
      notify: restart jellyfin

    - name: Configure firewall rules
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: "22", proto: "tcp" }
        - { port: "80", proto: "tcp" }
        - { port: "443", proto: "tcp" }
        - { port: "443", proto: "udp" }
        - { port: "8096", proto: "tcp" }
        - { port: "8920", proto: "tcp" }
        - { port: "1900", proto: "udp" }
        - { port: "7359", proto: "udp" }

    - name: Allow Samba through firewall
      ufw:
        rule: allow
        name: Samba

    - name: Enable firewall
      ufw:
        state: enabled

    - name: Create mount point for external drive
      file:
        path: /mnt/phat
        state: directory
        mode: '0755'

    - name: Add fstab entry for external drive
      lineinfile:
        path: /etc/fstab
        line: "UUID=BAEC-B479 /mnt/phat exfat defaults,nofail 0 0"
        state: present
        backup: yes

    - name: Create shared media directory
      file:
        path: /srv/media
        state: directory
        mode: '0777'
        owner: nobody
        group: nogroup

#    - name: Create media folders in /mnt/phat
#      file:
#        path: "/mnt/phat/{{ item }}"
#        state: directory
#        mode: '0777'
#        owner: nobody
#        group: nogroup
#      loop:
#        - TV
#        - Movies
#        - Photos
#        - Music
#
#    - name: Create media folders in /srv/media
#      file:
#        path: "/srv/media/{{ item }}"
#        state: directory
#        mode: '0777'
#        owner: nobody
#        group: nogroup
#      loop:
#        - TV
#        - Movies
#        - Photos
#        - Music
#
#    - name: Create media sync script
#      copy:
#        content: |
#          #!/bin/bash
#
#          # Media sync script - moves files from /mnt/phat to /srv/media
#
#          FOLDERS=("TV" "Movies" "Photos" "Music")
#          SOURCE_BASE="/mnt/phat"
#          DEST_BASE="/srv/media"
#
#          for folder in "${FOLDERS[@]}"; do
#              SOURCE_DIR="$SOURCE_BASE/$folder"
#              DEST_DIR="$DEST_BASE/$folder"
#
#              # Check if source directory exists and has content
#              if [ -d "$SOURCE_DIR" ] && [ "$(ls -A "$SOURCE_DIR" 2>/dev/null)" ]; then
#                  echo "Moving files from $SOURCE_DIR to $DEST_DIR"
#
#                  # Move all files and directories from source to destination
#                  find "$SOURCE_DIR" -mindepth 1 -maxdepth 1 -exec mv {} "$DEST_DIR/" \;
#
#                  echo "Moved contents of $folder folder"
#              else
#                  echo "No files to move in $folder folder"
#              fi
#          done
#
#          echo "Media sync completed at $(date)"
#        dest: /usr/local/bin/media-sync.sh
#        mode: '0755'
#        owner: root
#        group: root
#
#    - name: Set up cron job for media sync
#      cron:
#        name: "Media sync from /mnt/phat to /srv/media"
#        minute: "*/30"
#        job: "/usr/local/bin/media-sync.sh >> /var/log/media-sync.log 2>&1"
#        user: root

    - name: Configure Samba global settings for Mac compatibility
      blockinfile:
        path: /etc/samba/smb.conf
        insertafter: "\\[global\\]"
        block: |
          # Mac compatibility settings
          vfs objects = catia fruit streams_xattr
          fruit:metadata = stream
          fruit:model = MacSamba
          fruit:posix_rename = yes
          fruit:veto_appledouble = no
          fruit:wipe_intentionally_left_blank_rfork = yes
          fruit:delete_empty_adfiles = yes
          fruit:advertise_fullsync = true
          
          # Network discovery
          netbios name = JELLYFIN-SERVER
          server string = Jellyfin Media Server
          workgroup = WORKGROUP
          
          # Enable network browsing
          local master = yes
          domain master = yes
          preferred master = yes
          os level = 65
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Mac Compatibility"
      notify: restart samba

    - name: Configure Samba share for media folder
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [media]
              comment = Jellyfin Media Share
              path = /srv/media
              browseable = yes
              read only = no
              guest ok = yes
              create mask = 0664
              directory mask = 0775
              force user = nobody
              force group = nogroup
              # Mac-specific options
              vfs objects = catia fruit streams_xattr
              fruit:time machine = no
              fruit:locking = netatalk
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Media Share"
      notify: restart samba

    - name: Start and enable Samba service
      systemd:
        name: smbd
        state: started
        enabled: yes

    - name: Start and enable Avahi daemon for network discovery
      systemd:
        name: avahi-daemon
        state: started
        enabled: yes

    - name: Create Caddyfile for Jellyfin reverse proxy
      copy:
        content: |
          {{ jellyfin_domain }} {
              reverse_proxy 127.0.0.1:8096
          }
        dest: /etc/caddy/Caddyfile
        owner: root
        group: root
        mode: '0644'
      notify: restart caddy

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        state: started
        enabled: yes
        daemon_reload: yes


  handlers:
    - name: restart jellyfin
      systemd:
        name: jellyfin
        state: restarted

    - name: restart samba
      systemd:
        name: smbd
        state: restarted

    - name: restart caddy
      systemd:
        name: caddy
        state: restarted